
@{
    ViewBag.Title = "ParkLot_SetBillingTemplate";
    Layout = null;
}

<link href="~/Content/main.css" rel="stylesheet" />
<link href="~/Content/bootstrap.css" rel="stylesheet" />
<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<script src="~/Scripts/popper.min.js"></script>
<script src="~/Scripts/bootstrap.js"></script>
<script src="~/Scripts/main.js"></script>
<script src="~/Scripts/plugins/pace.min.js"></script>
<script type="text/javascript" src="~/Scripts/plugins/chart.js"></script>
<script src="~/Scripts/jquery.cookie.js"></script>
<script src="~/Scripts/jquery.serializejson.js"></script>
<script src="~/Scripts/jquery.validate.js"></script>
<link href="~/Content/Site.css" rel="stylesheet" />
<script src="~/Scripts/common.js"></script>
<style>
    a {
        font-size: 12px;
    }

    #car0List, #car2List {
        list-style: none;
        padding: 0;
    }

        #car0List li, #car2List li {
            padding-top: 10px;
            list-style: none;
            width: 100%;
            height: 40px;
            background-color: #fff;
            cursor: pointer;
            color: #6C7A8B;
        }

            #car0List li span, #car2List li span {
                font-size: 12px;
                padding-left: 50px;
                border-left: 2px solid #fff;
                height: 20px;
                display: block;
                line-height: 20px;
            }

    .border_b {
        border-left: 2px solid #0092FF !important;
    }

    .bgc_b {
        background-color: #E8F6FF !important;
    }
</style>

<div id="sampleTable_wrapper" class="dataTables_wrapper container-fluid dt-bootstrap4 no-footer" style="height: 100vh; display: flex; flex-direction: column;">
    <div class="row" style="height:20px"></div>
    <div class="row" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
        <div class="col-lg-12" style="flex: 1; overflow: hidden;display: flex;flex-direction: column;">
            <div class="bs-component" style="flex:1;display: flex;flex-direction: column;">
                <ul class="nav nav-tabs">
                    <li class="nav-item active" id="liA"><a class="nav-link" data-toggle="tab" href="#home" style="font-size: 12px;">计费模板设置</a></li>
                    <li class="nav-item" id="liB"><a class="nav-link" data-toggle="tab" href="#profile" style="font-size: 12px;">固定车延期金额设置</a></li>
                </ul>
                <div class="tab-content BillingTemplate_div" id="myTabContent" style="flex: 1;overflow:auto">
                    <div class="tab-pane active" id="home" style="width:100%;">
                        <div class="" style="height:55px;line-height:55px;">
                            @*<div class="col-sm-10 col-md-8">
                                    <div class="dataTables_length" id="" style="padding-left: 15px;">
                                        <img src="~/picture/zuobianlan.png" />
                                        <label class="parkName" style="font-size:18px;font-weight:bold;margin-left:12px"></label>
                                    </div>
                                </div>*@
                            <div class="col-md-1" style="width:110px;float:left">
                                <label class="control-label " style="font-size: 12px;">选择计费方式</label>
                            </div>
                            <div class="col-md-1" style="width:140px;float:left;margin-top:12px;">
                                <select class="selectpicker" name="TemplateIndex" id="TemplateIndex" data-width="140px" onchange="GetBilTemp()" style="height:30px;font-size:12px;" autocomplete="off">
                                    <option id="1" value="1">按小时计费</option>
                                    <option id="2" value="2">分段计费</option>
                                    <option id="3" value="3">深圳商业收费</option>
                                    <option id="4" value="4">按半小时收费</option>
                                    <option id="5" value="5">简易分段收费</option>
                                    <option id="6" value="6">分段按小时收费</option>
                                    <option id="7" value="7">无分段半小时收费</option>
                                    <option id="8" value="8">半小时收费</option>
                                    <option id="9" value="9">新分段收费标准</option>
                                    <option id="10" value="10">分段按15分钟收费</option>
                                </select>
                            </div>
                        </div>
                        <div class="" style="padding-top:10px;">
                            <div class="col-lg-2">
                                <div class="bs-component" style="border:1px solid #e7e9ed;width:95%;margin-left:12px">
                                    <div style="width:100%;height:35px;background-color:#f3f8fb;line-height:22px">
                                        <label style="line-height:34px;margin-left:10px;font-size:15px">车类型</label>
                                    </div>
                                    <div class="tree" style="width:100%;overflow-x:hidden;overflow-y:auto;height:350px;padding-top:10px;">
                                        <ul style="padding:0;width:120%;">
                                            <li style="list-style-type:none;margin-left:10px;">
                                                <i class="fas fa-caret-down btn1">
                                                    <img src="~/picture/caret-down-solid.svg" style="width:20px;height:20px" />
                                                </i>
                                                <span class=" ">临时车</span>
                                                <ul id="car0List" style="height:auto;width:100%;margin-left:-10px;" class=""></ul>
                                            </li>

                                            <li style="list-style-type:none;margin-left:10px;">
                                                <i class="fas fa-caret-down btn2">
                                                    <img src="~/picture/caret-down-solid.svg" style="width:20px;height:20px" />
                                                </i>
                                                <span class=" ">储值车</span>
                                                <ul id="car2List" style="height:auto;width:100%;margin-left:-10px;" class=""></ul>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-10">
                                <div class="panel" style="width:95%;float:left;height:580px;margin-bottom:0;">
                                    <iframe id="Tollcontext" name="TollcontextName" style="width:100%;height:100%;margin-left:30px;" frameborder="0" scrolling="no"></iframe>
                                </div>
                            </div>
                        </div>
                        <br />
                        <div style="margin:0 auto; width: 100%;padding: 10px 0;float: left;text-align: center;">
                            <button class="btn btn-default" type="reset" style=" color: #747474;background-color: #D7D8D9; width:120px;" onclick="back_ParkLot()">返回</button>
                            <button class="btn btn-primary" style="width:120px" type="submit" id="SaveBtn" onclick="checkData()">保存</button>
                        </div>
                    </div>
                    <div class="tab-pane" id="profile" style="height:444px;">
                        <p>
                            <div class="col-md-12">
                                <div class="row" style="height:55px">
                                    <div class="col-sm-12 col-md-6">
                                        @*<div class="dataTables_length" id="sampleTable_length">
                                                <img src="~/picture/zuobianlan.png" />
                                                <label class="parkName" style="font-size:18px;font-weight:bold;margin-left:12px">富士智能停车场</label>
                                            </div>*@
                                    </div>
                                    <div class="col-sm-12 col-md-6" style="text-align:right">
                                        <div id="sampleTable_filter" class="dataTables_filter">
                                            <a class="btn btn-info" onclick="showAdd()" style="color:#fff;background-color:#0092FF"> <img src="~/picture/increase.png" />&nbsp;&nbsp;<span>新添数据</span></a>

                                        </div>
                                    </div>
                                </div>
                                <div style="overflow:auto;height:400px">
                                    <table class="table table-striped table-bordered" style="border:1px solid #bfbfbf;text-align:center;">
                                        <thead style="background-color:#e8f6ff">
                                            <tr style="font-size:15px;text-align:center;">
                                                @*<th>#</th>*@
                                                <th style="text-align:center">卡类型</th>
                                                @*<th>续费月数</th>*@
                                                <th style="text-align:center">金额（元）</th>
                                                <th style="text-align:center">操作时间</th>
                                                <th style="text-align:center">操作人</th>
                                                <th style="text-align:center">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody_content"></tbody>
                                    </table>
                                </div>
                            </div>
                        </p>
                        <input type="hidden" id="projectGuid" value="" />
                        <input type="hidden" id="parkingCode" value="" />
                        <input type="hidden" id="parkName" value="" />
                        <input type="hidden" id="navtabs" value="" />
                        <div class="tile-footer">
                            <div class="row">
                                <div class="col-md-10" style="text-align:center">
                                    <a class="btn " href="#" onclick="back_ParkLot()" style="width:120px;margin-left:30%;background-color:#D7D8D9;color:#575656">
                                        返回
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@*添加*@
<div class="col-sm-12">
    <div class="modal fade" id="div_add" tabindex="-1" role="dialog" aria-labelledby="div_AddInRecord">
        <div class="modal-dialog" role="document" style="margin-left:0px">
            <div class="modal-content">
                <div class="modal-header title_background-color" style="background-color:#0092ff">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-right:10px"><span aria-hidden="true">&times;</span></button>
                    <h3 class="modal-title" id="div_AddInRecord">新增</h3>
                </div>
                <form>
                    <div class="form-group" style="width:100%;height:45px;margin-top:10px">
                        <div class="float-left text-right" style="width:20%;">
                            <label>车类类型：</label>
                        </div>
                        <div class="float-left" style="width:70%;">
                            @*<input type="text" class="form-control" name="username" id="carTypeName" />*@
                            <select class="form-control" id="CarTypeGuid"></select>
                        </div>
                    </div>
                    @*<div class="form-group" style="width:100%;height:45px">
                            <div class="float-left text-right" style="width:20%;">
                                <label>月数：</label>
                            </div>
                            <div class="float-left" style="width:70%;">
                                <select class="form-control" id="Months">
                                    <option selected="" value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                </select>
                            </div>
                        </div>*@
                    <div class="form-group" style="width:100%;height:45px">
                        <div class="float-left text-right" style="width:20%;">
                            <label>金额：</label>
                        </div>
                        <div class="float-left" style="width:70%;">
                            <input type="text" class="form-control" name="email" id="Amount" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>关闭</button>
                        @*<button type="submit" name="submit" class="btn btn-primary" onclick="SavaAdd()">保存</button>*@
                        <button class="btn btn-primary" type="button" onclick="SavaAdd()" style="width:80px" id="btnSavaAdd">
                            <i class="fa fa-fw fa-lg fa-check-circle">
                            </i>保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
@*编辑*@
<div class="col-sm-12">
    <div class="modal fade" id="div_edit" tabindex="-1" role="dialog" aria-labelledby="div_AddInRecord">
        <div class="modal-dialog" role="document" style="margin-left:0px">
            <div class="modal-content">
                <div class="modal-header title_background-color" style="background-color:#0092ff">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-right:10px"><span aria-hidden="true">&times;</span></button>
                    <h3 class="modal-title" id="div_AddInRecord">编辑</h3>
                </div>
                <form>
                    <div class="form-group" style="width:100%;height:45px;margin-top:10px">
                        <div class="float-left text-right" style="width:20%;">
                            <label>车类类型：</label>
                        </div>
                        <div class="float-left" style="width:70%;">
                            @*<input type="text" class="form-control" name="username" id="carTypeName" />*@
                            <select class="form-control" id="Edit_CarTypeGuid" disabled="disabled"></select>
                        </div>
                    </div>
                    @*<div class="form-group" style="width:100%;height:45px">
                            <div class="float-left text-right" style="width:20%;">
                                <label>月数：</label>
                            </div>
                            <div class="float-left" style="width:70%;">
                                <select class="form-control" id="Edit_Months" disabled="disabled">
                                    <option selected="" value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                </select>
                            </div>
                        </div>*@
                    <div class="form-group" style="width:100%;height:45px">
                        <div class="float-left text-right" style="width:20%;">
                            <label>金额：</label>
                        </div>
                        <div class="float-left" style="width:70%;">
                            <input type="text" class="form-control" name="email" id="Edit_Amount" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>关闭</button>
                        @*<button type="submit" name="submit" class="btn btn-primary" onclick="SavaEdit()">保存</button>*@
                        <button class="btn btn-primary" type="button" onclick="SavaEdit()" style="width:80px">
                            <i class="fa fa-fw fa-lg fa-check-circle">
                            </i>保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var strcarTypeName = "";
    var projectGuid = $.cookie("ProjectGuid");
    var tabs = "";
    var PostponeTemplateList = "";
    var _iframe = window.parent;
    var _div = _iframe.document.getElementById('main_loading');
    $(document).ready(function () {

        _div.style.display = 'block';
        var str = location.href; //取得整个地址栏
        var num = str.indexOf("?")
        str = str.substr(num + 1); //取得所有参数   stringvar.substr(start [, length ]
        var arr = str.split("&"); //各个参数放到数组里
        if (arr.length > 0) {  //大于1 是修改  否则是添加
            var value = "";
            for (var i = 0; i < arr.length; i++) {
                num = arr[i].indexOf("=");
                if (num > 0) {
                    name = arr[i].substring(0, num);
                    value = arr[i].substr(num + 1);
                    $("#" + name).val(decodeURI(value));
                }
            }
        }
        $(".parkName").html($("#parkName").val())
        GetPostponeTemplateList();
        GetCarTypeList()
        var tabs = $("#navtabs").val();
        if (tabs != "") {
            $('#liA').removeClass('active');
            $('#liB').addClass('active');
            $('#home').removeClass('active');
            $('#profile').addClass('active');
        }



    })

    //弹出添加页面
    function showAdd() {
        _div.style.display = 'block';
        //$('#btnSavaAdd').removeAttr("disabled");
        GetCarTypeModel(1, "");
        $('#div_add').modal();
        _div.style.display = 'none';
    }

    //弹出编辑页面
    function showEdit(carTypeGuid, months, amount) {
        _div.style.display = 'block';
        $("#Edit_CarTypeGuid").val(carTypeGuid);
        $("#Edit_Months").val(months);
        $("#Edit_Amount").val(amount)
        GetCarTypeModel(0, carTypeGuid);
        $('#div_edit').modal();
        _div.style.display = 'none';
    }

    //保存添加
    function SavaAdd() {
        _div.style.display = 'block';
        var ParkingCode = $("#parkingCode").val();
        var CarTypeGuid = $("#CarTypeGuid").val();
        var ProjectGuid = $.cookie("ProjectGuid");
        var UserName = $.cookie("UserName")
        //var Months = $("#Months").val();

        var Months = 0;
        var Amount = $("#Amount").val();

        for (var key in PostponeTemplateList) {
            var months = json[key].months;
            var carTypeGuid = json[key].carTypeGuid;
            if (CarTypeGuid == carTypeGuid && months == Months) {
                return $message('d', "已添加过相同的数据！")
            }
        }
        var data = {
            "Months": Months, "Amount": Amount, "ParkingCode": ParkingCode, "ProjectGuid": ProjectGuid, "CarTypeGuid": CarTypeGuid, "OperateUser": UserName
        };
        $.post("/Home/Maps/ParkLot/SetPostponeTemplate", data, function (result) {
            if (result.IsSuccess == true) {
                $message('s', "操作成功！");
                parent.$('#mainIframe').attr('src', "/Home/Trans/ParkLot_SetBillingTemplate?projectGuid=" + ProjectGuid + "&parkingCode=" + ParkingCode + "&navtabs=1");
                _div.style.display = 'none';
                return;
            }
            else {
                $message('d', "添加不成功！")
                _div.style.display = 'none';
                return false;
            }
        });
    }

    //保存编辑
    function checkData () {
        $(window.frames["TollcontextName"].document).find("#form input[type='submit']").click()
    }
    function SavaEdit() {
        _div.style.display = 'block';
        var ParkingCode = $("#parkingCode").val();
        var CarTypeGuid = $("#Edit_CarTypeGuid").val();
        var ProjectGuid = $.cookie("ProjectGuid");
        var UserName = $.cookie("UserName")
        //var Months = $("#Edit_Months").val();
        var Months = 0;
        var Amount = $("#Edit_Amount").val();
        var data = {
            "Months": Months, "Amount": Amount, "ParkingCode": ParkingCode, "ProjectGuid": ProjectGuid, "CarTypeGuid": CarTypeGuid, "OperateUser": UserName
        };
        $.post("/Home/Maps/ParkLot/SetPostponeTemplate", data, function (result) {
            if (result.IsSuccess == true) {
                $message('s', "操作成功！")
                //location.reload()
                location.reload();
                parent.$('#mainIframe').attr('src', "/Home/Trans/ParkLot_SetBillingTemplate?projectGuid=" + ProjectGuid + "&parkingCode=" + ParkingCode + "&navtabs=1");
                _div.style.display = 'none';
                return;
            }
            else {
                $message('d', "添加不成功！");
                _div.style.display = 'none';
                return false;
            }
        });
    }

    //获取固定车延期模板列表
    function GetPostponeTemplateList() {
        _div.style.display = 'block';
        strcarTypeName = "";
        var parkCode = $("#parkingCode").val();
        $.ajax({
            url: "/Home/Maps/ParkLot/GetPostponeTemplateList?ParkingCode=" + parkCode,
            dataType: 'json',
            method: 'GET',
            contentType: "application/json;utf-8",
            success: function (data) {
                if (data.IsSuccess == true) {
                    PostponeTemplateList = data.Result;
                    json = PostponeTemplateList;
                    for (var key in json) {
                        var months = json[key].Months;
                        var amount = json[key].Amount;
                        var operateTime = json[key].OperateTime;
                        var operateUser = json[key].OperateUser;
                        var carTypeGuid = json[key].CarTypeGuid;
                        var projectGuid = json[key].ProjectGuid;
                        var parkCode = json[key].ParkCode;
                        var carTypeName = json[key].CarTypeName;
                        strcarTypeName = strcarTypeName + carTypeName + ",";
                        var html = html + "<tr id='" + "Id_" + key + "' style='font-size: 15px'>" +
                            '<td>' + carTypeName + '</td>' +
                            ' <td>' + amount + '</td>' +
                            '<td>' + operateTime + '</td>' +
                            '<td>' + operateUser + '</td>' +
                            "<td><a class='btn btn-info icon-btn mr-10' style='color: #e8f6ff;width:100px;background-color:#0092FF' onclick='showEdit(\"" + carTypeGuid + "\",\"" + months + "\",\"" + amount + "\")'>编辑</a> <a  class='btn ' style='color: #e8f6ff;background-color:#b0b0b0;width:100px' onclick='Delete(\"" + carTypeGuid + "\",\"" + projectGuid + "\",\"" + key + "\",\"" + months + "\",\"" + amount + "\",\"" + operateUser + "\",\"" + parkCode + "\")'>删除</a></td>" +
                            '</tr >';
                    }
                    $("#tbody_content").append(html);
                    
                }
                _div.style.display = 'none';
            }
        })
    }

    //新添数据
    function Add() {
        _div.style.display = 'block';
        var projectGuid = $.cookie("ProjectGuid");
        var parkCode = $("#parkingCode").val();
        var url = ("/Home/Trans/ParkLot_AddBillingTemplate?projectGuid=" + projectGuid + "&parkingCode=" + parkCode);
        parent.$('#mainIframe').attr('src', url);
        var html = "<p style='font-style:initial'>" +
            '<label style = "color:#a3a8ac" > 车场管理</label>  > <a  href="#" onclick="Back()" style="color:#9a9c9e"> 车场设置</a>><a href="#" style="color:#9a9c9e" onclick="back_ParkLot()">计费设置</a>  > <label style="color:#0092ff">添加</label>' +
            '</p >';
        parent.document.getElementById('app-title').innerHTML = html;
        _div.style.display = 'none';
    }

    //获取车类下拉列表
    //0 代表编辑
    function GetCarTypeModel(type, carTypeGuid) {

        var ParkingCode = $("#parkingCode").val();
        $.ajax({
            url: "/Home/Maps/ParkLot/GetCarTypeList?ParkingCode=" + ParkingCode + '&projectGuid=' + $.cookie("ProjectGuid"),
            dataType: '',
            method: '',
            contentType: '',
            success: function (data) {
                if (data.IsSuccess == true) {
                    var json = data.Result;
                    $("#CarTypeGuid").find("option").remove();
                    $("#Edit_CarTypeGuid").find("option").remove();
                    var index = 0;
                    for (var key in json) {
                        var guid = json[key].Guid;
                        var carTypeName = json[key].CarTypeName;
                        if (json[key].CarType != 0 && json[key].Enable == true && json[key].CarType != 2) {
                            if (type == 1) {
                                if (strcarTypeName.indexOf(carTypeName) == -1) {
                                    $("#CarTypeGuid").append("<option value='" + guid + "'>" + carTypeName + "</option>");
                                    index++;
                                }

                            }
                            else {
                                if (carTypeGuid == guid) {
                                    $("#Edit_CarTypeGuid").append("<option value='" + guid + "' selected='selected'>" + carTypeName + "</option>");
                                }
                                else {
                                    $("#Edit_CarTypeGuid").append("<option value='" + guid + "'>" + carTypeName + "</option>");
                                }
                            }
                        }

                    }
                    _div.style.display = 'none';
                    //if (index == 0) {

                    //    //$("#btnSavaAdd").arr("disabled", "disabled");
                    //    $("#CarTypeGuid").append("<option value='0' selected='selected'>车类型已用完</option>");
                    //}
                }
            }
        })
    }

    //编辑
    function Edit(carTypeGuid, months, amount) {
        _div.style.display = 'block';
        var projectGuid = $.cookie("ProjectGuid");
        var parkCode = $("#parkingCode").val();
        var url = ("/Home/Trans/ParkLot_AddBillingTemplate?projectGuid=" + projectGuid + "&Months=" + months + "&Amount=" + amount + "&parkingCode=" + parkCode + "&carTypeGuid=" + carTypeGuid);
        parent.$('#mainIframe').attr('src', url);
        var html = "<p style='font-style:initial'>" +
            '<label style = "color:#a3a8ac" > 车场管理</label>  > <a  href="#" onclick="Back()" style="color:#9a9c9e"> 车场设置</a>><a href="#" onclick="back_ParkLot()" style="color:#9a9c9e">计费设置</a>  > <label style="color:#0092ff">修改</label>' +
            '</p >';
        parent.document.getElementById('app-title').innerHTML = html;
        _div.style.display = 'none';
    }

    //删除
    function Delete(CarTypeGuid, projectGuid, key, months, amount, operateUser, parkCode) {
        
        var data = {
            "CarTypeGuid": CarTypeGuid,
            "ParkingCode": parkCode,
            "ProjectGuid": projectGuid,
            "Months": months,
            "Amount": amount,
            "OperateUser": operateUser
        };
        $alert({
            html: "您确定删除吗？",
            confirm: function () {
                _div.style.display = 'block';
                $.post("/Home/Maps/ParkLot/RemovePostponeTemplate", data, function (result) {
                    if (result.IsSuccess == true) {
                        //alert("删除成功！")
                        //$("#Id_" + key).remove();
                        location.reload();
                        parent.$('#mainIframe').attr('src', "/Home/Trans/ParkLot_SetBillingTemplate?projectGuid=" + projectGuid + "&parkingCode=" + parkCode + "&navtabs=1");
                        _div.style.display = 'none';
                        return;
                    }
                    else {
                        _div.style.display = 'none';
                        $message('d', result.MessageContent)
                        return false;
                    }
                });
            }
        })
    }

    //获取车类列表
    function GetCarTypeList() {
        _div.style.display = 'block';
        var parkCode = $("#parkingCode").val();
        $.ajax({
            url: "/Home/Maps/ParkLot/GetCarTypeList?ParkingCode=" + parkCode + '&projectGuid=' + $.cookie("ProjectGuid"),
            dataType: 'json',
            method: 'GET',
            contentType: "application/json;utf-8",
            success: function (data) {
                if (data.IsSuccess == true) {
                    if (data.Result.length == 0) {
                        $message('d', "请先设置车类")
                        history.back(-1);
                        return;
                    }
                    var json = data.Result;
                    for (var key in json) {
                        var guid = json[key].Guid;
                        var carTypeName = json[key].CarTypeName;
                        var carType = json[key].CarType;
                        if (json[key].CarType == 0) {
                            var html0 = '<li class="guidLi" carType="' + carType + '" guid="' + guid + '">' +
                                '<span guid="' + guid + '"><a href="javascript:;" style="text-decoration: none;">' + carTypeName + '</a></span>' +
                                '</li>';
                            $("#car0List").append(html0);
                        } else if (json[key].CarType == 2) {
                            var html2 = '<li class="guidLi" carType="' + carType + '" guid="' + guid + '">' +
                                '<span guid="' + guid + '"><a href="javascript:;" style="text-decoration: none;">' + carTypeName + '</a></span>' +
                                '</li>';
                            $("#car2List").append(html2);
                        }
                    }
                    $(".tree .guidLi").click(function () {
                        $(".tree .guidLi span a").css("color", "#000");
                        $(".tree .guidLi span").removeClass("border_b");
                        $(".tree .guidLi").removeClass("bgc_b");
                        $(this).find("a").css("color", "#0092FF")
                            .end().find("span").addClass("border_b")
                            .end().addClass("bgc_b");
                        GetBillingTemplate()
                    })
                    $(".tree .guidLi").eq(0).trigger("click");
                }
                _div.style.display = 'none';
            }
        })
    }

    //添加
    //获取计费模板
    function GetBillingTemplate() {
        _div.style.display = 'block';
        var carTypeGuid = $(".guidLi .border_b").attr("guid");
        $.ajax({
            url: "/Home/Maps/ParkLot/GetBillingTemplate?CarTypeGuid=" + carTypeGuid,
            dataType: 'json',
            method: 'GET',
            contentType: "application/json;charset=utf-8",
            success: function (res) {
                var val = res.Result ? res.Result.ChargeMode : 1;
                switch (val) {
                    case 1: //按小时计费
                        var url = ("/Home/Trans/BT_HourlyTollView?carTypeGuid=" + carTypeGuid);
                        parent.$("iframe").contents().find("#Tollcontext").attr('src', url);
                        $('#TemplateIndex option').eq(0).prop("selected", true).siblings().prop("selected", false)
                        break;
                    case 2: //分段计费
                        var url = ("/Home/Trans/BT_SectMoney?carTypeGuid=" + carTypeGuid);
                        parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                        $('#TemplateIndex option').eq(1).prop("selected", true).siblings().prop("selected", false)
                        break;
                    case 3: //深圳商业收费
                        var url = ("/Home/Trans/BT_ShenZhengToll?carTypeGuid=" + carTypeGuid);
                        parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                        $('#TemplateIndex option').eq(2).prop("selected", true).siblings().prop("selected", false)
                        break;
                    case 4: //按半小时收费
                        var url = ("/Home/Trans/BT_HalfHourMoney?carTypeGuid=" + carTypeGuid);
                        parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                        $('#TemplateIndex option').eq(3).prop("selected", true).siblings().prop("selected", false)
                        break;
                    case 5: //简易分段收费
                        var url = ("/Home/Trans/BT_SimplesectMoney?carTypeGuid=" + carTypeGuid);
                        parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                        $('#TemplateIndex option').eq(4).prop("selected", true).siblings().prop("selected", false)
                        break;
                    case 6: //分段按小时计费
                        var url = ("/Home/Trans/BT_SecthourMoney?carTypeGuid=" + carTypeGuid);
                        parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                        $('#TemplateIndex option').eq(5).prop("selected", true).siblings().prop("selected", false)
                        break;
                    case 7: //无分段半小时收费
                        var url = ("/Home/Trans/BT_Sectnone2Money?carTypeGuid=" + carTypeGuid);
                        parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                        $('#TemplateIndex option').eq(6).prop("selected", true).siblings().prop("selected", false)
                        break;
                    case 8: //半小时收费
                        var url = ("/Home/Trans/BT_HalfHourSectMoney?carTypeGuid=" + carTypeGuid);
                        parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                        $('#TemplateIndex option').eq(7).prop("selected", true).siblings().prop("selected", false)
                        break;
                    case 9: //新分段收费标准
                        var url = ("/Home/Trans/BT_NewSubparagraphFees?carTypeGuid=" + carTypeGuid);
                        parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                        $('#TemplateIndex option').eq(8).prop("selected", true).siblings().prop("selected", false)
                        break;
                    case 10: //分段按15分钟收费
                        var url = ("/Home/Trans/BT_Sect1Money?carTypeGuid=" + carTypeGuid);
                        parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                        $('#TemplateIndex option').eq(9).prop("selected", true).siblings().prop("selected", false)
                        break;
                }
                _div.style.display = 'none';
            }
        })

    }

    //计费模板静态跳转
    function GetBilTemp() {
        _div.style.display = 'block';
        var carTypeGuid = $(".guidLi .border_b").attr("guid");
        var val = $('#TemplateIndex option:selected').val();
        switch (val || "1") {
            case "1": //按小时计费
                var url = ("/Home/Trans/BT_HourlyTollView?carTypeGuid=" + carTypeGuid);
                parent.$("iframe").contents().find("#Tollcontext").attr('src', url);
                break;
            case "2": //分段计费
                var url = ("/Home/Trans/BT_SectMoney?carTypeGuid=" + carTypeGuid);
                parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                break;
            case "3": //深圳商业收费
                var url = ("/Home/Trans/BT_ShenZhengToll?carTypeGuid=" + carTypeGuid);
                parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                break;
            case "4": //按半小时收费
                var url = ("/Home/Trans/BT_HalfHourMoney?carTypeGuid=" + carTypeGuid);
                parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                break;
            case "5": //简易分段收费
                var url = ("/Home/Trans/BT_SimplesectMoney?carTypeGuid=" + carTypeGuid);
                parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                break;
            case "6": //分段按小时计费
                var url = ("/Home/Trans/BT_SecthourMoney?carTypeGuid=" + carTypeGuid);
                parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                break;
            case "7": //无分段半小时收费
                var url = ("/Home/Trans/BT_Sectnone2Money?carTypeGuid=" + carTypeGuid);
                parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                break;
            case "8": //半小时收费
                var url = ("/Home/Trans/BT_HalfHourSectMoney?carTypeGuid=" + carTypeGuid);
                parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                break;
            case "9": //新分段收费标准
                var url = ("/Home/Trans/BT_NewSubparagraphFees?carTypeGuid=" + carTypeGuid);
                parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                break;
            case "10": //分段按15分钟收费
                var url = ("/Home/Trans/BT_Sect1Money?carTypeGuid=" + carTypeGuid);
                parent.$('iframe').contents().find('#Tollcontext').attr('src', url);
                break;
        }
        _div.style.display = 'none';
    }

    //新增计费模板
    function AddBillingTemplate() {
        _div.style.display = 'block';
        var texttemplateJson = $(window.frames["TollcontextName"].document).find("#form").serialize();
        if (/=(&|$)/.test(texttemplateJson)) {
            $message('d', "值不能为空");
            return false;
        }
        var parkCode = $("#parkingCode").val();
        var chargeMode = $('#TemplateIndex option:selected').val();
        var projectGuid = $.cookie("ProjectGuid");
        var carTypeGuid = $(".guidLi .border_b").attr("guid");
        //获取iframe内的DOM
        var templateJson = $(window.frames["TollcontextName"].document).find("#form").serializeJSON();
        var dataTemJSON = JSON.stringify(templateJson).replace(/"/g, '\\"');
        //dataTemJSON = "[" + dataTemJSON + "]";
        var dataObj = {
            ParkingCode: parkCode,
            CarTypeGuid: carTypeGuid,
            TemplateJson: dataTemJSON,
            ChargeMode: chargeMode,
            ProjectGuid: projectGuid
        };

        $.ajax({
            method: 'POST',
            url: "/Home/Maps/ParkLot/AddBillingTemplate",
            dataType: 'json',
            data: dataObj,
            success: function (data) {
                if (data.IsSuccess == true) {
                    $message('s', "设置成功！")
                } else if (data.IsSuccess == false) {
                    $message('d', data.MessageContent)
                }
                _div.style.display = 'none';
            }
        })
    }

    //修改计费模板
    function ModifyBillingTemplate() {
        _div.style.display = 'block';
        var texttemplateJson = $(window.frames["TollcontextName"].document).find("#form").serialize();
        if (/=(&|$)/.test(texttemplateJson)) {
            $message('d', "值不能为空");
            return false;
        }
        var parkCode = $("#parkingCode").val();
        var chargeMode = $('#TemplateIndex option:selected').val();
        var projectGuid = $.cookie("ProjectGuid");
        var carTypeGuid = $(".guidLi .border_b").attr("guid");
        //获取iframe内的DOM
        var templateJson = $(window.frames["TollcontextName"].document).find("#form").serializeJSON();
        var dataTemJSON = JSON.stringify(templateJson).replace(/"/g, '\\"');
        var dataObj = {
            ParkingCode: parkCode,
            CarTypeGuid: carTypeGuid,
            TemplateJson: dataTemJSON,
            ChargeMode: chargeMode,
            ProjectGuid: projectGuid
        };

        $.ajax({
            method: 'POST',
            url: "/Home/Maps/ParkLot/ModifyBillingTemplate",
            dataType: 'json',
            data: dataObj,
            success: function (data) {
                if (data.IsSuccess == true) {
                    $message('s', "设置成功！")
                } else if (data.IsSuccess == false) {
                    $message('d', data.MessageContent)
                }
                _div.style.display = 'none';
            }
        })
    }

    //删除计费模板
    function RemoveBillingTemplate() {
        _div.style.display = 'block';
        var parkCode = $("#parkingCode").val();
        var chargeMode = $('#TemplateIndex option:selected').val();
        var projectGuid = $.cookie("ProjectGuid");
        var carTypeGuid = $(".guidLi .border_b").attr("guid");
        //获取iframe内的DOM
        var templateJson = $(window.frames["TollcontextName"].document).find("#form").serialize();

        var dataObj = {
            ParkingCode: parkCode,
            CarTypeGuid: carTypeGuid,
            TemplateJson: templateJson,
            ChargeMode: chargeMode,
            ProjectGuid: projectGuid
        };
        $.ajax({
            url: "/Home/Maps/ParkLot/RemoveBillingTemplate",
            data: dataObj,
            dataType: 'json',
            method: 'POST',
            success: function (data) {
                if (data.IsSuccess == true) {
                    $message('s', "保存成功！")
                } else if (data.IsSuccess == false) {
                    $message('d', data.MessageContent)
                }
                _div.style.display = 'none';
            }
        })
    }

    //SaveBtn提交flag
    function SaveBtn() {
        if ($(window.frames["TollcontextName"].document).find("#form").attr("flag") == "0") {
            AddBillingTemplate()
        } else if ($(window.frames["TollcontextName"].document).find("#form").attr("flag") == "1") {
            ModifyBillingTemplate()
        }
    }

    //返回车场页面
    function back_ParkLot() {
        _div.style.display = 'block';
        var html = "<p style='font-style:initial'>" +
            "<label style ='color:#a3a8ac'> 车场管理><a  href='#' onclick=\"Back()\"> 车场设置</a>" +
            '</p >';
        parent.document.getElementById('app-title').innerHTML = html;
        parent.$('#mainIframe').attr('src', "/Home/Trans/ParklotIndex");
        _div.style.display = 'none';
    }


</script>
